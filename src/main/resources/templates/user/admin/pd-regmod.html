<!DOCTYPE HTML>
<!--
	Editorial by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="layout/default">
<th:layout layout:fragment="main">
	<!-- Section -->
	<section>
		<header class="main">
			<h1>상품 등록</h1>
		</header>
		<form method="post" th:action="@{/admin/product/regdo}" th:object="${product}" enctype="multipart/form-data" onsubmit="return regProduct(this)" >
			<input type="hidden" th:if="*{i_product != null and i_product > 0}" th:field="*{i_product}">
			<input type="hidden" th:field="*{change_yn}" value="N">
			<div class="row gtr-uniform">
				<div class="col-6">
<!--					<select class="ref_category" name="ref_category" id="ref_category">
						<option value="">전체</option>
					</select>-->
				</div>
				<div class="col-6">
<!--					<select class="i_category" name="i_category" id="i_category">
						<option value="">전체</option>
					</select>-->
					<input type="number" name="i_category" th:value="${product.i_category}" placeholder="작은 카테고리">
				</div>
				<div class="col-6 col-12-xsmall">
					<input type="text" name="p_nm" id="demo-name" th:value="${product.p_nm}" placeholder="상품명" />
				</div>
				<div class="col-6 col-12-xsmall">
					<input type="text" name="price" id="demo-email" th:value="${product.price}" placeholder="가격" />
				</div>
				<div class="col-6 col-12-xsmall">
					<input type="text" name="stock" id="demo-email1" th:value="${product.stock}" placeholder="수량" />
				</div>

											
				<!-- Break -->
				<div class="col-12">
					<textarea name="p_description" id="content" th:value="${product.p_description}" placeholder="상품 설명을 적어주세요" rows="6"></textarea>
				</div>

				<div data-name="fileDiv" class="form-group filebox">
					<label for="file_0">파일1</label>
					<div class="col-12">
						<input type="text" class="upload-name" value="파일 찾기" readonly>
						<label for="file_0" class="custom-control-label">찾아보기</label>
						<input type="file" name="files" id="file_0" class="upload-hidden" onchange="changeFilename(this)">

						<button type="button" onclick="addFile()">
							<i class="fa fa-plus" aria-hidden="true"></i>
						</button>
						<button type="button" onclick="removeFile(this)">
							<i class="fa fa-minus" aria-hidden="true"></i>
						</button>
					</div>
				</div>

				<!--저장된 파일이 있는 파일 영역-->
				<div th:unless="${#lists.isEmpty( fileList )}" th:each="row, status : ${fileList}" data-name="fileDiv" class="form-group">
					<label th:for="|file_${status.index}|" class="col-2">[[ |파일${status.count}| ]]</label>
					<div class="col-10">
						<input type="hidden" name="i_file" th:value="${row.i_file}">
						<input type="text" class="upload-name" th:value="${row.original_name}" readonly>
						<label th:for="|file_${status.index}|" class="custom-control-label">찾아보기</label>
						<input type="file" name="files" th:id="|file_${status.index}|" class="upload-hidden" onchange="changeFilename(this)"/>
						<button th:if="${status.first}" type="button" onclick="addFile()">
							<i class="fa fa-plus" aria-hidden="true"></i>
						</button>
						<button type="button" onclick="removeFile(this)"><i class="fa fa-minus" aria-hidden="true"></i></button>
					</div>
				</div>

				<!-- Break -->
				<div class="col-12">
					<ul class="actions btn">
						<li><button type="submit" value="등록" class="primary large">등록</button></li>
					</ul>
				</div>
			</div>
		</form>
	</section>
</th:layout>
<script>

	/*<![CDATA[*/

	function regProduct(form) {
		var result = (
				isValid(form.p_nm, "상품명", null, null)
				&& isValid(form.price, "가격", null, null)
				&& isValid(form.stock, "수량", null, null)
		);

		if(result == false) {
			return false;
		}

		var idx = /*[[ ${product.i_product} ]]*/;
		if(isEmpty(idx) == false) {
			var queryString = /*[[ ${param.makeQueryString(param.currentPageNo)} ]]*/;

			/*[- 쿼리 스트링을 오브젝트 형태로 변환 -]*/
			queryString = new URLSearchParams(queryString);
			queryString.forEach(function(value, key) {
				if (isEmpty(value) == false) {
					$(form).append('<input type="hidden" name="' + key + '" value="' + value + '" />');
				}
			});
		}
	}
	/*[- end of function -]*/

	const fileList = /*[[ ${fileList} ]]*/; /*[- 업로드 파일 리스트 -]*/
	let fileIdx = isEmpty(fileList) ? 0 : fileList.length; /*[- 파일 인덱스 처리용 전역 변수 -]*/

	function addFile() {
		const fileDivs = $('div[data-name="fileDiv"]');
		if(fileDivs.length > 5) {
			alert('파일은 최대 다섯 개 까지 업로드 할 수 있습니다.');
			return false;
		}

		document.getElementById('change_yn').value = 'Y';
		fileIdx++;

		const fileHtml = `
		<div th:if="${#lists.isEmpty( fileList )}" data-name="fileDiv" class="form-group filebox bs3-primary">
			<label for="file_${i_file}" class="col-sm-2 control-label"></label>
			<div class="col-sm-10">
				<input type="text" class="upload-name" value="파일 찾기" readonly />
				<label for="file_${i_file}" class="control-label">찾아보기</label>
				<input type="file" name="files" id="file_${i_file}" class="upload-hidden" onchange="changeFilename(this)" />

				<button type="button" onclick="removeFile(this)" class="btn btn-bordered btn-xs visible-xs-inline visible-sm-inline visible-md-inline visible-lg-inline">
					<i class="fa fa-minus" aria-hidden="true"></i>
				</button>
			</div>
		</div>
	`;

		$('#btn').before(fileHtml);
	}

	function removeFile(elem) {

		document.getElementById('change_yn').value = 'Y';

		const prevTag = $(elem).prev().prop('tagName');
		if (prevTag === 'BUTTON') {
			const file = $(elem).prevAll('input[type="file"]');
			const filename = $(elem).prevAll('input[type="text"]');
			file.val('');
			filename.val('파일 찾기');

			$(elem).prevAll('input[name="i_file"]').remove();
			return false;
		}

		const target = $(elem).parents('div[data-name="fileDiv"]');
		target.remove();
	}
	/*[- end of function -]*/

	function changeFilename(file) {

		document.getElementById('change_yn').value = 'Y';

		file = $(file);
		const filename = file[0].files[0].name;
		const target = file.prevAll('input.upload-name');
		target.val(filename);

		file.prevAll('input[name="i_file"]').remove();
	}
	/*[- end of function -]*/

	/*]]>*/

	//컨드롤러에서 데이터 받기
	var jsonData = JSON.parse('${category}');
	console.log(jsonData);

	//필요한 배열과 오브젝트 변수 생성
	var refArr = new Array();
	var refObj = new Object();

	//1차 분류 셀렉트 박스에 삽입할 데이터 준비
	for(var i=0; i<jsonData.length; i++) {
		if(jsonData[i].ref_category == null) {
			refObj = new Object();

			//refObj에 i_category와 c_nm을 저장
			refObj.ref_category = jsonData[i].i_category;
			refObj.c_nm = jsonData[i].c_nm;

			//refObj에 저장된 값을 refArr 배열에 저장
			refArr.push(refObj);
		}
	}

	//1차 분류 셀렉트 박스에 데이터 삽입
	var refSelect = $("select.ref_category");

	for(var i=0; i<refArr.length; i++) {
		//refObj에 저장된 값을 refSelect에 추가
		refSelect.append("<option value='" + refArr[i].i_category + "'>" + refArr[i].c_nm + "</option>");
	}

	//클래스가 ref_category인 select 변수의 값이 바뀌었을 때 실행
	$(document).on("change", "select.ref_category", function() {
		//필요한 배열과 오브젝트 변수를 생성
		var ictArr = new Array();
		var ictObj = new Object();

		//2차 분류 셀렉트 박스에 삽입할 데이터 준비
		for(var i=0; i<jsonData.length; i++) {

			if(jsonData[i].ref_category != null) {
				ictObj = new Object();

				//ictObj에 i_category, c_nm, ref_category를 저장
				ictObj.i_category = jsonData[i].i_category;
				ictObj.c_nm = jsonData[i].c_nm;

				//ictObj에 저장된 값을 refArr 배열에 저장
				ictArr.push(ictObj);
			}
		}

		var ictSelect = $("select.i_category");

		//ictSelect의 값을 제거함(초기화)
		ictSelect.children().remove();

		//refSelect에서 선택한 값을 기준으로 ictSelect의 값을 조정
		$("option:selected", this).each(function() {
			var selectVal = $(this).val();  //현재 선택한 refSelect의 값을 저장

			ictSelect.append("<option value='" + selectVal + "'>전체</option>");  //ictSelect의 '전체'에 현재 선택한 refSelect와 같은 값 부여

			//ictArr의 데이터를 refSelect에 추가
			for(var i=0; i<ictArr[i].i_category; i++) {
				if(selectVal == ictArr[i].i_category) {
					ictSelect.append("<option value='" + ictArr[i].i_category + "'>" + ictArr[i].c_nm + "</option>");
				}
			}
		});
	});
</script>
</html>